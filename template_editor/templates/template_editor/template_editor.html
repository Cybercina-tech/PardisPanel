{% extends "base.html" %}
{% load static %}

{% block title %}Template Editor Â· {{ template.name }}{% endblock %}

{% block content %}
<div class="py-4">
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
            <div class="text-center text-md-start">
                <h1 class="template-editor-title fw-bold mb-2">
                    Template Editor: {{ template.name }}
                </h1>
                <p class="template-editor-subtitle mb-0">Configure text fields and their positions</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'template_editor_frontend:list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to List
                </a>
                <button type="button" id="saveBtn" class="btn btn-gold">
                    <i class="fas fa-save me-2"></i>
                    Save Template
                </button>
            </div>
        </div>
    </div>

    <div class="editor-container">
        <!-- Left Panel: Field Configuration -->
        <div class="editor-left">
            <!-- Add New Field Form -->
            <div class="add-field-form">
                <h4 class="template-editor-section-title mb-4 text-center">
                    Add Text Field
                </h4>
                <form id="addFieldForm">
                    <div class="template-editor-form-group">
                        <label class="template-editor-label" for="fieldName">Field Name <span class="text-danger">*</span></label>
                        <input type="text" id="fieldName" class="form-control theme-input" placeholder="e.g., english_date" required>
                        <small class="form-text text-muted d-block mt-1">This will be the key used in dynamic_data_dict</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="template-editor-form-group">
                                <label class="template-editor-label" for="fieldX">X Coordinate <span class="text-danger">*</span></label>
                                <input type="number" id="fieldX" class="form-control theme-input" min="0" step="1" value="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="template-editor-form-group">
                                <label class="template-editor-label" for="fieldY">Y Coordinate <span class="text-danger">*</span></label>
                                <input type="number" id="fieldY" class="form-control theme-input" min="0" step="1" value="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="template-editor-form-group">
                                <label class="template-editor-label" for="fieldSize">Font Size <span class="text-danger">*</span></label>
                                <input type="number" id="fieldSize" class="form-control theme-input" min="8" max="200" value="32" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="template-editor-form-group">
                                <label class="template-editor-label" for="fieldColor">Color <span class="text-danger">*</span></label>
                                <input type="color" id="fieldColor" class="form-control theme-input template-color-input" value="#000000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="template-editor-form-group">
                                <label class="template-editor-label" for="fieldAlign">Alignment</label>
                                <select id="fieldAlign" class="form-select theme-input">
                                    <option value="left">Left</option>
                                    <option value="center">Center</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="template-editor-form-group">
                                <label class="template-editor-label" for="fieldMaxWidth">Max Width (optional)</label>
                                <input type="number" id="fieldMaxWidth" class="form-control theme-input" min="0" step="1" placeholder="Auto">
                            </div>
                        </div>
                    </div>
                    
                    <div class="template-editor-form-group">
                        <label class="template-editor-label" for="fieldWeight">Font Weight</label>
                        <input type="text" id="fieldWeight" class="form-control theme-input" value="normal" placeholder="normal, bold, etc.">
                    </div>
                    
                    <div class="template-editor-form-group">
                        <label class="template-editor-label" for="fieldFont">Font</label>
                        <select id="fieldFont" class="form-select theme-input">
                            <option value="">Default (montsrrat.otf)</option>
                            {% for filename, display_name in available_fonts %}
                            <option value="{{ filename }}">{{ display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-gold w-100 mt-3">
                        <i class="fas fa-plus me-2"></i>
                        Add Field
                    </button>
                </form>
            </div>

            <!-- Existing Fields List -->
            <div class="field-list">
                <h4 class="template-editor-section-title mb-4 text-center">
                    Configured Fields
                </h4>
                <div id="fieldsList">
                    <p class="template-editor-empty-message text-center">No fields added yet. Add a field above to get started.</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Live Preview -->
        <div class="editor-right">
            <div class="preview-panel">
                <h4 class="template-editor-section-title mb-4 text-center">
                    Live Preview
                </h4>
                <div class="template-preview-container mb-3">
                    <img id="previewImage" class="preview-image" src="{% url 'template_editor_frontend:preview' template.pk %}" alt="Preview">
                </div>
                <button type="button" id="refreshPreview" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-sync me-2"></i>
                    Refresh Preview
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Security: Use json_script filter to safely pass JSON data to JavaScript -->
{{ config|json_script:"template-config-data" }}
<input type="hidden" id="templateId" value="{{ template.pk }}">
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'template_editor/template_editor.js' %}"></script>
{% endblock %}
