# ูุณุชูุฏุงุช ุงุฑุณุงู ููุชโูุง ุจู API ุฎุงุฑุฌ

ุงู ูุณุชูุฏุงุช ูุญูู ุงุฑุณุงู ฺูุงุฑ ููุช (GBP ู USDT - ุฎุฑุฏ ู ูุฑูุด) ุจู API ูุจโุณุงุช ุตุฑุงู ูพุฑุฏุณ ุฑุง ุชูุถุญ ูโุฏูุฏ.

## ๐ ููุฑุณุช ูุทุงูุจ

- [ููุง ฺฉู](#ููุง-ฺฉู)
- [ููุชโูุง ุงุฑุณุงู](#ููุชโูุง-ุงุฑุณุงู)
- [ุณุงุฎุชุงุฑ API](#ุณุงุฎุชุงุฑ-api)
- [ูุญูู ฺฉุงุฑ](#ูุญูู-ฺฉุงุฑ)
- [ุชูุธูุงุช](#ุชูุธูุงุช)
- [ูุซุงูโูุง ุงุณุชูุงุฏู](#ูุซุงูโูุง-ุงุณุชูุงุฏู)
- [ุนุจโุงุจ](#ุนุจโุงุจ)

## ููุง ฺฉู

ุณุณุชู Pardis Panel ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ููุชโูุง ููุงโุดุฏู (finalized) ุฑุง ุจู API ุฎุงุฑุฌ ูุจโุณุงุช `https://sarafipardis.co.uk` ุงุฑุณุงู ูโฺฉูุฏ. ุงู ุงุฑุณุงู ุฏุฑ ุฏู ุญุงูุช ุงูุฌุงู ูโุดูุฏ:

1. **Finalize ฺฉุฑุฏู ฺฉ Category**: ููฺฏุงู finalize ฺฉุฑุฏู ููุชโูุง ฺฉ ุฏุณุชูโุจูุฏ (ูุซูุงู ุชุชุฑ ุง ูพููุฏ)
2. **Finalize ฺฉุฑุฏู Special Price**: ููฺฏุงู finalize ฺฉุฑุฏู ฺฉ ููุช ูฺู

### ูุงูโูุง ูุฑุชุจุท

- `finalize/services.py`: ุดุงูู ฺฉูุงุณ `ExternalAPIService` ฺฉู ูุณุฆูู ุงุฑุณุงู ููุชโูุง ุงุณุช
- `finalize/views.py`: ุดุงูู view ูุง finalize ฺฉู ุงุฒ ุณุฑูุณ ุงุณุชูุงุฏู ูโฺฉููุฏ

## ููุชโูุง ุงุฑุณุงู

ุณุณุชู ููุท ฺูุงุฑ ููุช ุฒุฑ ุฑุง ุจู API ุงุฑุณุงู ูโฺฉูุฏ:

| ฺฉูุฏ | ุชูุถุญุงุช | ูุซุงู | ููุจุน |
|------|---------|------|------|
| `GBP_BUY` | ููุช ุฎุฑุฏ ูพููุฏ ุจู ุชููุงู | 163,000 | **ููุท ูพููุฏ ุญุณุงุจ** (ูู ููุฏ) |
| `GBP_SELL` | ููุช ูุฑูุด ูพููุฏ ุจู ุชููุงู | 172,000 | **ููุท ูพููุฏ ุญุณุงุจ** (ูู ููุฏ) |
| `USDT_BUY` | ููุช ุฎุฑุฏ ุชุชุฑ ุจู ุชููุงู | 126,000 | ุชุชุฑ ุจู ุชููุงู |
| `USDT_SELL` | ููุช ูุฑูุด ุชุชุฑ ุจู ุชููุงู | 150,000 | ุชุชุฑ ุจู ุชููุงู |

### ูฺฉุงุช ููู

- **ุจุฑุง ูพููุฏ (GBP)**: ููุท ููุชโูุง "ุญุณุงุจ" (account) ุงุฑุณุงู ูโุดููุฏ. ููุชโูุง "ููุฏ" (cash) ูุงุฏุฏู ฺฏุฑูุชู ูโุดููุฏ
  - ุณุณุชู ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง ฺฉููู "ุญุณุงุจ" ุง "account" ุฏุฑ ูุงู `PriceType` ูุฌูุฏ ุฏุงุฑุฏ
  - ุงฺฏุฑ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ ุขู ููุช skip ูโุดูุฏ
  
- **ุจุฑุง ุชุชุฑ (USDT)**: ููุท ููุชโูุง ุจู ุชููุงู (IRR) ุงุฑุณุงู ูโุดููุฏ
  - ุฌูุช ุงุฑุฒ ุจุงุฏ `USDT/IRR` ุง `USDT/IRT` ุจุงุดุฏ
  - **ููุชโูุง ุชุชุฑ ุจู ูพููุฏ (USDT/GBP) ุงุฑุณุงู ููโุดููุฏ**
  
- ููุท ููุชโูุง ูุฑุจูุท ุจู ุฌูุช ุงุฑุฒูุง `GBP/IRR` (ุง `GBP/IRT`) ู `USDT/IRR` (ุง `USDT/IRT`) ุงุฑุณุงู ูโุดููุฏ
- ููุชโูุง ุณุงุฑ ุงุฑุฒูุง (ูุซู USD, EUR ู ุบุฑู) ูุงุฏุฏู ฺฏุฑูุชู ูโุดููุฏ
- ููุน ูุนุงููู (`trade_type`) ุจุงุฏ `buy` ุง `sell` ุจุงุดุฏ

## ุณุงุฎุชุงุฑ API

### Endpoint

```
POST https://sarafipardis.co.uk/wp-json/pardis/v1/rates
```

### ุฏุฑุฎูุงุณุช (Request)

ุจุฑุง ูุฑ ููุชุ ฺฉ ุฏุฑุฎูุงุณุช POST ุฌุฏุงฺฏุงูู ุงุฑุณุงู ูโุดูุฏ:

```json
{
  "currency": "USDT_SELL",
  "rate": 150000.0,
  "api_key": "PX9k7mN2qR8vL4jH6wE3tY1uI5oP0aS9dF7gK2mN8xZ4cV6bQ1wE3rT5yU8iO0pL"
}
```

#### ูพุงุฑุงูุชุฑูุง

- `currency` (string, required): ฺฉ ุงุฒ ฺูุงุฑ ฺฉูุฏ (`GBP_BUY`, `GBP_SELL`, `USDT_BUY`, `USDT_SELL`)
- `rate` (float, required): ููุฏุงุฑ ููุช ุจู ุตูุฑุช ุนุฏุฏ ุงุนุดุงุฑ
- `api_key` (string, required): ฺฉูุฏ API ุจุฑุง ุงุญุฑุงุฒ ููุช

#### Headers

```
Content-Type: application/json
```

### ูพุงุณุฎ (Response)

API ููฺฉู ุงุณุช ฺฉ ูพุงุณุฎ JSON ุจุฑฺฏุฑุฏุงูุฏ ุง ูฺ ฺุฒ ุจุฑูฺฏุฑุฏุงูุฏ. ุฏุฑ ูุฑ ุฏู ุญุงูุชุ ุงฺฏุฑ status code 200 ุจุงุดุฏุ ุงุฑุณุงู ูููู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.

### ุฎูุงูุฏู ููุชโูุง ููุฌูุฏ (GET)

ุจุฑุง ุฎูุงูุฏู ููุชโูุง ูุนู ุงุฒ API:

```
GET https://sarafipardis.co.uk/wp-json/pardis/v1/rates
```

ูพุงุณุฎ ููููู:

```json
{
  "GBP_BUY": 163000,
  "GBP_SELL": 172000,
  "USDT_BUY": 126000,
  "USDT_SELL": 150000
}
```

## ูุญูู ฺฉุงุฑ

### 1. ุงุณุชุฎุฑุงุฌ ููุชโูุง ุงุฒ Price Items

ููฺฏุงู ฺฉู ฺฉ category finalize ูโุดูุฏุ ุชุงุจุน `send_finalized_prices()` ูุฑุงุฎูุงู ูโุดูุฏ:

```python
price_items = [
    (price_type, price_history),
    # ... ุณุงุฑ ููุชโูุง
]

results = ExternalAPIService.send_finalized_prices(price_items)
```

ุชุงุจุน `_build_rates_from_items()` ููุชโูุง ุฑุง ุงุณุชุฎุฑุงุฌ ูโฺฉูุฏ:

1. ุจุฑุง ูุฑ `(price_type, price_history)`:
   - ฺฉุฏ ุงุฑุฒ ูุจุฏุฃ ู ููุตุฏ ุฑุง ูโุฎูุงูุฏ
   - ููุน ูุนุงููู (`buy` ุง `sell`) ุฑุง ูโุฎูุงูุฏ
   - ููุฏุงุฑ ููุช ุฑุง ุงุฒ `price_history.price` ูโุฎูุงูุฏ
   - ุงฺฏุฑ ุฌูุช ุงุฑุฒ `GBP/IRR` ุง `USDT/IRR` ุจุงุดุฏุ ฺฉูุฏ ููุงุณุจ ุฑุง ูโุณุงุฒุฏ

### 2. ุณุงุฎุช ฺฉูุฏูุง

```python
# ุจุฑุง GBP - ููุท ุญุณุงุจ (account)
if pair == {"GBP", "IRR"} or pair == {"GBP", "IRT"}:
    # ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง "ุญุณุงุจ" ุง "account" ุฏุฑ ูุงู price_type ูุฌูุฏ ุฏุงุฑุฏ
    is_account = "ุญุณุงุจ" in price_type.name or "account" in price_type.name.lower()
    
    if is_account:
        key = "GBP_BUY" if trade_type == "buy" else "GBP_SELL"
    else:
        # ูพููุฏ ููุฏ ุฑุง skip ูโฺฉูุฏ
        continue

# ุจุฑุง USDT - ููุท ุจู ุชููุงู
elif pair == {"USDT", "IRR"} or pair == {"USDT", "IRT"}:
    key = "USDT_BUY" if trade_type == "buy" else "USDT_SELL"
```

### 3. ุงุฑุณุงู ููุชโูุง

ุณุณุชู **ููุท** ููุชโูุง ุงุณุชุฎุฑุงุฌโุดุฏู ุงุฒ `price_items` ุฑุง ุงุฑุณุงู ูโฺฉูุฏ:
- ุจุฏูู ุฎูุงูุฏู ุงุฒ API ุง ุฏุชุงุจุณ
- ุจุฏูู fallback ุจู ููุงุฏุฑ ูุจู
- ุจุฑุง ูุฑ ฺฉูุฏ ุงุณุชุฎุฑุงุฌโุดุฏูุ ฺฉ ุฏุฑุฎูุงุณุช POST ุฌุฏุงฺฏุงูู

### 4. ูุซุงู ุฌุฑุงู ฺฉุงุฑ

```
1. ฺฉุงุฑุจุฑ category "ุชุชุฑ" ุฑุง finalize ูโฺฉูุฏ
   โ
2. price_items ุดุงูู:
   - (USDT_BUY_price_type, price_history_1) โ ููุช: 126,000
   - (USDT_SELL_price_type, price_history_2) โ ููุช: 150,000
   โ
3. _build_rates_from_items() ุงุณุชุฎุฑุงุฌ ูโฺฉูุฏ:
   {
     "USDT_BUY": 126000.0,
     "USDT_SELL": 150000.0
   }
   โ
4. ุงุฑุณุงู ููุท ููุงู ููุงุฏุฑ ุงุณุชุฎุฑุงุฌโุดุฏู (2 ุฏุฑุฎูุงุณุช POST):
   POST /rates {"currency": "USDT_BUY", "rate": 126000, ...}
   POST /rates {"currency": "USDT_SELL", "rate": 150000, ...}

(ููุชโูุง USDT/GBP ุงุฑุณุงู ููโุดููุฏ - ููุท USDT/IRR)
```

## ุชูุธูุงุช

### ูุชุบุฑูุง ูุญุท (Environment Variables)

ูโุชูุงูุฏ ุงุฒ ูุชุบุฑูุง ูุญุท ุจุฑุง ุชูุธู URL ู API Key ุงุณุชูุงุฏู ฺฉูุฏ:

```bash
# URL API
export EXTERNAL_API_URL="https://sarafipardis.co.uk/wp-json/pardis/v1/rates"

# API Key
export EXTERNAL_API_KEY="your-api-key-here"
```

### ุชูุธูุงุช Django (settings.py)

```python
EXTERNAL_API_URL = os.environ.get('EXTERNAL_API_URL', 'https://sarafipardis.co.uk/wp-json/pardis/v1/rates')
EXTERNAL_API_KEY = os.environ.get('EXTERNAL_API_KEY', '')
```

**ููู:** API Key ุฑุง ุงุฒ ุทุฑู ูุชุบุฑ ูุญุท `EXTERNAL_API_KEY` ุชูุธู ฺฉูุฏ. ููุฏุงุฑ ูพุดโูุฑุถ ุฎุงู ุงุณุช.

## ูุซุงูโูุง ุงุณุชูุงุฏู

### ุงุณุชูุงุฏู ุฏุฑ View

```python
from finalize.services import ExternalAPIService

# ุฏุฑ finalize_category view
price_items = [
    (price_type_1, price_history_1),
    (price_type_2, price_history_2),
    # ...
]

# ุงุฑุณุงู ุฎูุฏฺฉุงุฑ
results = ExternalAPIService.send_finalized_prices(price_items)

# ุจุฑุฑุณ ูุชุงุฌ
if results.get("sent"):
    print(f"Successfully sent {len(results['sent'])} rates")
if results.get("failed"):
    print(f"Failed to send {len(results['failed'])} rates")
```

## ุนุจโุงุจ

### ูุงฺฏโูุง

ุณุณุชู ูุงฺฏโูุง ููุตู ุจุฑุง ุฑุฏุงุจ ุงุฑุณุงู ููุชโูุง ุฏุงุฑุฏ:

```python
# ูุงฺฏโูุง ููู:
logger.info("Extracted USDT_SELL = 150000 from USDT/IRR sell")
logger.info("Rates to send: {...}")
logger.info("Sent USDT_SELL = 150000 successfully")
logger.info("External API: N sent, M failed")
```

### ูุดฺฉูุงุช ุฑุงุฌ

#### 1. ููุช ูุฑูุด ุชุชุฑ ุนุฏุฏ 1 ุฑุง ูุดุงู ูโุฏูุฏ

**ุนูุช**: ููุช ูุฑูุด ุชุชุฑ ุฏุฑ `price_items` ูุณุช ุง ุจู ุฏุฑุณุช ุงุณุชุฎุฑุงุฌ ููโุดูุฏ.

**ุฑุงูโุญู**:
- ุจุฑุฑุณ ฺฉูุฏ ฺฉู `PriceType` ุจุฑุง ูุฑูุด ุชุชุฑ ุจุง `trade_type='sell'` ู ุฌูุช ุงุฑุฒ `USDT/IRR` ูุฌูุฏ ุฏุงุฑุฏ
- ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ ุชุง ุจุจูุฏ ุขุง ููุช ูุฑูุด ุชุชุฑ ุฏุฑ `price_items` ุงุณุช
- ุจุฑุฑุณ ฺฉูุฏ ฺฉู `trade_type` ุจู ุฏุฑุณุช `"sell"` ุงุณุช (ูู `"Sell"` ุง `"SELL"`)

#### 2. ููุช ูพููุฏ ุงุฒ ููุฏ ุงุณุชูุงุฏู ูโุดูุฏ ุจู ุฌุง ุญุณุงุจ

**ุนูุช**: ุณุณุชู ูุจูุงู ุงุฒ ูุฑ ููุช ูพููุฏ ุงุณุชูุงุฏู ูโฺฉุฑุฏ.

**ุฑุงูโุญู**:
- ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู `PriceType` ุจุฑุง ูพููุฏ ุดุงูู ฺฉููู "ุญุณุงุจ" ุง "account" ุฏุฑ ูุงู ุฎูุฏ ุงุณุช
- ููุชโูุง ูพููุฏ ููุฏ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ skip ูโุดููุฏ
- ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ ุชุง ุจุจูุฏ ฺฉุฏุงู ููุชโูุง skip ุดุฏูโุงูุฏ

#### 2. ููุช ุงุฑุณุงู ููโุดูุฏ

**ุนูุช**: ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง API ุง ูุดฺฉู ุฏุฑ API Key.

**ุฑุงูโุญู**:
- ุจุฑุฑุณ ูุงฺฏโูุง ุจุฑุง ุฎุทุงูุง HTTP
- ุจุฑุฑุณ ุตุญุช API Key
- ุจุฑุฑุณ ุฏุณุชุฑุณ ุจู ุงูุชุฑูุช ู URL API

### ุชุณุช

ุจุฑุง ุชุณุช ุงุฑุณุงู ููุชโูุงุ ูโุชูุงูุฏ ุงุฒ ุชุณุชโูุง ููุดุชู ุดุฏู ุงุณุชูุงุฏู ฺฉูุฏ:

```bash
# ุงุฌุฑุง ุชุณุชโูุง
python manage.py test finalize.tests.ExternalAPIServiceTest

# ุชุณุช ุฎุงุต ุงุฑุณุงู ููุช ูุฑูุด ุชุชุฑ
python manage.py test finalize.tests.ExternalAPIServiceTest.test_send_usdt_sell_price_150000
```

## ูฺฉุงุช ููู

1. **ุงุฑุณุงู ุฌุฏุงฺฏุงูู**: ุจุฑุง ูุฑ ฺฉ ุงุฒ ฺูุงุฑ ููุชุ ฺฉ ุฏุฑุฎูุงุณุช POST ุฌุฏุงฺฏุงูู ุงุฑุณุงู ูโุดูุฏ

2. **ุจุฏูู fallback**: ููุท ููุชโูุง ุงุณุชุฎุฑุงุฌโุดุฏู ุงุฒ `price_items` ุงุฑุณุงู ูโุดููุฏุ ุจุฏูู ุฎูุงูุฏู ุงุฒ API ุง ุฏุชุงุจุณ

3. **Timeout**: 10 ุซุงูู ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช

4. **Error Handling**: ุงฺฏุฑ ุงุฑุณุงู ฺฉ ููุช ุจุง ุฎุทุง ููุงุฌู ุดูุฏุ ุณุงุฑ ููุชโูุง ููฺูุงู ุงุฑุณุงู ูโุดููุฏ ู ุฎุทุง ุจุง stack trace ฺฉุงูู ูุงฺฏ ูโุดูุฏ

5. **USDT/GBP ุงุฑุณุงู ููโุดูุฏ**: ููุท ุชุชุฑ ุจู ุชููุงู (USDT/IRR ุง USDT/IRT)

## ุณุงุฎุชุงุฑ ฺฉุฏ

```
finalize/
โโโ services.py
โ   โโโ _build_rates_from_items()  # ุงุณุชุฎุฑุงุฌ ุงุฒ price_items
โ   โโโ _send_one_rate()           # ุงุฑุณุงู ฺฉ POST
โ   โโโ ExternalAPIService.send_finalized_prices()
โ   โโโ ExternalAPIService.send_finalized_special_prices()
โโโ views.py
```

## ูพุดุชุจุงู

ุจุฑุง ุณูุงูุงุช ุง ูุดฺฉูุงุชุ ูุงฺฏโูุง ุณุณุชู ุฑุง ุจุฑุฑุณ ฺฉูุฏ ุง ุจุง ุชู ุชูุณุนู ุชูุงุณ ุจฺฏุฑุฏ.

