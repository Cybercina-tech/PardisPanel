{% extends "base.html" %}
{% load static %}
{% load special_price_tags %}

{% block title %}Special Price Management Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0 text-gold">Special Price Management Dashboard</h1>
                <div class="text-gold-light time-display">
                    <div class="time-english" id="current-time"></div>
                    <div class="time-jalali" id="current-time-jalali"></div>
                </div>
            </div>
            <hr class="border-gold">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <a href="{% url 'special_price:add_type' %}" class="btn btn-gold">
                    <i class="fas fa-plus me-2"></i>Add New Special Price Type
                </a>
            </div>
        </div>
    </div>

    <!-- Validity Notice -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning border-gold">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Important:</strong> Special prices are valid for up to <strong>6 hours</strong>, or until new special price types are added. After that, they will no longer be valid.
            </div>
        </div>
    </div>

    <!-- Special Price Types Grid -->
    <div class="row">
        {% for special_price_type in special_price_types %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-gold h-100">
                <div class="card-header bg-black-secondary border-bottom-gold">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-gold">{{ special_price_type.name }}</h5>
                        <div class="btn-group">
                            <a href="{% url 'special_price:edit_type' special_price_type.id %}" 
                               class="btn btn-sm btn-outline-light border-gold text-gold" 
                               title="Edit Special Price Type">
                                <i class="fas fa-cog fa-xs"></i>
                            </a>
                            <a href="{% url 'special_price:delete_type' special_price_type.id %}" 
                               class="btn btn-sm btn-outline-danger border-danger text-danger" 
                               title="Delete Special Price Type"
                               onclick="return confirm('Are you sure you want to delete this special price type? This will also delete all its price history.');">
                                <i class="fas fa-trash fa-xs"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item bg-dark border-light-gold">
                            <div class="row align-items-center">
                                <div class="col">
                                    <div class="small">
                                        <span class="text-gold-light me-3">{{ special_price_type.source_currency.code }} / {{ special_price_type.target_currency.code }}</span>
                                        <span class="badge bg-light-gold text-dark">{{ special_price_type.get_trade_type_display }}</span>
                                    </div>
                                    {% if special_price_type.description %}
                                    <div class="mt-2">
                                        <small class="text-white-50">{{ special_price_type.description }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-auto">
                                    {% with latest_price=special_price_type.special_price_histories.first %}
                                    {% if latest_price %}
                                    <div class="text-end small">
                                        <div class="text-gold mb-1">Price: {{ latest_price.price }}</div>
                                        <div class="text-gold small">
                                            Last update: 
                                            <span>{{ latest_price.updated_at|date:"F d, Y H:i" }}</span>
                                            {% if latest_price.updated_at|to_jalali:"short" %}
                                                <span class="ms-1 text-white-50">/ {{ latest_price.updated_at|to_jalali:"short" }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-gold">No prices set</div>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="col-auto">
                                    <div class="btn-group">
                                        <a href="{% url 'special_price:update_price' special_price_type.id %}" 
                                           class="btn btn-sm btn-gold" 
                                           title="Update Price">
                                            <i class="fas fa-edit me-1"></i>Update Price
                                        </a>
                                        <a href="{% url 'special_price:price_history' special_price_type.id %}" 
                                           class="btn btn-sm btn-outline-light border-gold text-gold" 
                                           title="View History">
                                            <i class="fas fa-history fa-xs"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No special price types found. Click the "Add New Special Price Type" button above to create one.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .border-gold {
        border-color: var(--gold-primary) !important;
    }
    
    .border-light-gold {
        border-color: rgba(212, 175, 55, 0.2) !important;
    }
    
    .bg-light-gold {
        background-color: var(--gold-primary) !important;
    }
    
    .list-group-item {
        transition: all 0.2s ease;
    }
    
    .list-group-item:hover {
        background-color: rgba(212, 175, 55, 0.05) !important;
    }

    .btn-outline-light.border-gold:hover {
        background-color: #000 !important;
        border-color: var(--gold-primary) !important;
        color: var(--gold-primary) !important;
    }
    
    /* Live Time Display Styling */
    .time-display {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.15rem;
    }
    
    .time-english {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--gold-light);
        white-space: nowrap;
    }
    
    .time-jalali {
        font-size: 0.8rem;
        font-weight: 400;
        color: rgba(247, 239, 138, 0.75);
        white-space: nowrap;
    }

    /* Alert Styling */
    .alert-warning {
        background-color: rgba(212, 175, 55, 0.1) !important;
        border-color: var(--gold-primary, #D4AF37) !important;
        color: var(--gold-primary, #D4AF37) !important;
    }

    .alert-info {
        background-color: var(--card-bg, #121212) !important;
        border-color: var(--border-color, rgba(212, 175, 55, 0.3)) !important;
        color: var(--text-primary, #e9ecef) !important;
    }

    .btn-gold {
        background: linear-gradient(135deg, var(--theme-primary, #D4AF37) 0%, var(--theme-dark, #B8860B) 100%) !important;
        border: 1px solid var(--theme-primary, #D4AF37) !important;
        color: var(--btn-text-color, #000) !important;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    [data-theme="light"] .btn-gold {
        --btn-text-color: #FFFFFF;
    }

    .btn-gold:hover {
        background: linear-gradient(135deg, var(--theme-light, #FFD700) 0%, var(--theme-primary, #D4AF37) 100%) !important;
        border-color: var(--theme-light, #FFD700) !important;
        color: var(--btn-text-color, #000) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px color-mix(in srgb, var(--theme-primary) 30%, transparent);
    }

    .btn-outline-danger {
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }

    .btn-outline-danger:hover {
        background-color: rgba(220, 53, 69, 0.2) !important;
        border-color: #dc3545 !important;
        color: #fff !important;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/jalaali-js@1.1.0/jalaali.js"></script>
<script>
    // Jalali date conversion function (inline fallback)
    function gregorianToJalali(gy, gm, gd) {
        var g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        var jy = (gy <= 1600) ? 0 : 979;
        gy -= (gy <= 1600) ? 621 : 1600;
        var gy2 = (gm > 2) ? (gy + 1) : gy;
        var days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + 
                   (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
        jy += 33 * (parseInt(days / 12053));
        days %= 12053;
        jy += 4 * (parseInt(days / 1461));
        days %= 1461;
        if (days > 365) {
            jy += parseInt((days - 1) / 365);
            days = (days - 1) % 365;
        }
        var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
        var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
        return {jy: jy, jm: jm, jd: jd};
    }
    
    function updateTime() {
        try {
            const now = new Date();
            
            // English date/time
            const timeString = now.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const englishElement = document.getElementById('current-time');
            if (englishElement) {
                englishElement.textContent = timeString;
            }
            
            // Convert to Tehran timezone (UTC+3:30)
            const tehranOffset = 3.5 * 60 * 60 * 1000; // Tehran is UTC+3:30
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
            const tehranTime = new Date(utcTime + tehranOffset);
            
            // Persian (Jalali) date using Tehran time
            const year = tehranTime.getFullYear();
            const month = tehranTime.getMonth() + 1;
            const day = tehranTime.getDate();
            
            // Use library if available, otherwise use inline function
            let jalali;
            if (typeof jalaali !== 'undefined' && jalaali.toJalaali) {
                jalali = jalaali.toJalaali(year, month, day);
            } else {
                jalali = gregorianToJalali(year, month, day);
            }
            
            // Persian month names
            const persianMonths = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
            const monthName = persianMonths[jalali.jm - 1];
            
            // Format: 15 فروردین 1403، 14:30:45
            const hours = String(tehranTime.getHours()).padStart(2, '0');
            const minutes = String(tehranTime.getMinutes()).padStart(2, '0');
            const seconds = String(tehranTime.getSeconds()).padStart(2, '0');
            const jalaliTime = `${jalali.jd} ${monthName} ${jalali.jy}، ${hours}:${minutes}:${seconds}`;
            
            const jalaliElement = document.getElementById('current-time-jalali');
            if (jalaliElement) {
                jalaliElement.textContent = jalaliTime;
            }
        } catch (error) {
            console.error('Error updating time:', error);
        }
    }
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
        });
    } else {
        updateTime();
        setInterval(updateTime, 1000);
    }
</script>
{% endblock %}

