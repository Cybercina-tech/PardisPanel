# Pardis Panel

A comprehensive price management and publishing system for currency exchange operations. Pardis Panel provides a complete solution for managing exchange rates, tracking price history, generating branded price images, and automatically publishing them to Telegram channels.

## üöÄ Features
hi
### Core Functionality

- **Category-Based Price Management**: Organize currency pairs and price types into logical categories for better management
- **Dual Price System**: 
  - Regular prices organized by categories
  - Special prices for promotional or time-sensitive rates
- **Price History Tracking**: Complete audit trail of all price changes with timestamps and notes
- **Currency Pair Management**: Support for multiple currencies with buy/sell trade types
- **Price Finalization Workflow**: Review and finalize prices before publication with approval tracking

### Publishing & Automation

- **Automated Telegram Publishing**: Seamlessly publish price updates to multiple Telegram channels
- **Custom Image Rendering**: Generate branded price images with customizable templates
- **Template System**: 
  - Default templates for general use
  - Category-specific templates
  - Special price templates
  - Background images, logos, and watermarks support
- **Visual Template Editor**: Drag-and-drop interface for creating and editing price templates
- **Multi-Channel Support**: Manage multiple Telegram bots and channels

### Analytics & Reporting

- **Comprehensive Analytics Dashboard**: 
  - Real-time price tracking with interactive charts
  - Price trend analysis and volatility metrics
  - Category summaries and statistics
  - Top movers identification
  - Finalization statistics
- **Historical Data Analysis**: 30-day price history visualization
- **Performance Metrics**: Track publication success rates and channel activity

### User Management & Security

- **Role-Based Access Control**: 
  - Management role
  - Employee role
  - Developer role
- **Custom Authentication**: Secure login system with session management
- **Activity Logging**: Comprehensive logging system for all operations
- **Audit Trail**: Track who finalized prices and when

### Additional Features

- **Settings Management**: Centralized configuration management
- **Log Viewer**: View and filter application logs by level and source
- **Persian Calendar Support**: Integration with jdatetime for Persian date handling
- **Responsive UI**: Modern, mobile-friendly interface

## üèóÔ∏è Architecture

### Technology Stack

- **Backend**: Django 5.2+
- **Database**: SQLite (development) / PostgreSQL (production-ready)
- **Image Processing**: Pillow (PIL)
- **Telegram Integration**: python-telegram-bot, Pyrogram
- **REST API**: Django REST Framework
- **Frontend**: HTML, CSS, JavaScript with Chart.js for analytics

### Project Structure

```
PardisPanel/
‚îú‚îÄ‚îÄ accounts/              # User authentication and management
‚îú‚îÄ‚îÄ analysis/              # Analytics dashboard and reporting
‚îú‚îÄ‚îÄ category/              # Category and price type management
‚îú‚îÄ‚îÄ change_price/          # Price update functionality
‚îú‚îÄ‚îÄ dashboard/             # Main dashboard
‚îú‚îÄ‚îÄ finalize/              # Price finalization workflow
‚îú‚îÄ‚îÄ price_publisher/       # Image rendering and Telegram publishing
‚îú‚îÄ‚îÄ setting/               # System settings and logging
‚îú‚îÄ‚îÄ special_price/         # Special price management
‚îú‚îÄ‚îÄ telegram_app/          # Telegram bot and channel management
‚îú‚îÄ‚îÄ template_editor/       # Visual template editor
‚îî‚îÄ‚îÄ SarafiPardis/          # Main project configuration
```

### Key Modules

#### Category Management (`category/`)
- `Currency`: Currency definitions (code, name, symbol)
- `Category`: Price categories for organization
- `PriceType`: Price types within categories (currency pairs, trade direction)

#### Price Management (`change_price/`)
- `PriceHistory`: Historical record of all price changes
- Bulk and individual price update interfaces
- Price validation and constraints

#### Special Prices (`special_price/`)
- `SpecialPriceType`: Standalone special price types
- `SpecialPriceHistory`: History tracking for special prices

#### Finalization (`finalize/`)
- `Finalization`: Tracks category price finalizations
- `SpecialPriceFinalization`: Tracks special price finalizations
- `FinalizedPriceHistory`: Links prices to finalizations

#### Price Publisher (`price_publisher/`)
- `PriceTemplate`: Template configuration (backgrounds, logos, watermarks)
- Image rendering services:
  - `PriceImageRenderer`: Main rendering engine
  - `LegacyCategoryRenderer`: Legacy category support
  - `TetherRenderer`: Specialized Tether rendering
- `PricePublisherService`: High-level publishing coordination

#### Template Editor (`template_editor/`)
- Visual drag-and-drop template editor
- RESTful API for template management
- Element positioning and styling

#### Analytics (`analysis/`)
- Interactive charts and graphs
- Statistical analysis (volatility, trends, averages)
- Category and channel activity metrics

#### Telegram Integration (`telegram_app/`)
- `TelegramBot`: Bot token management
- `TelegramChannel`: Channel configuration
- `TelegramService`: Message and photo sending
- Default message settings per bot

## üì¶ Installation

### Prerequisites

- Python 3.10+
- pip
- Virtual environment (recommended)

### Setup Steps

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd PardisPanel
   ```

2. **Create and activate virtual environment**
   ```bash
   python -m venv venv
   # On Windows
   venv\Scripts\activate
   # On Linux/Mac
   source venv/bin/activate
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

4. **Configure settings**
   - Update `SarafiPardis/settings.py` with your configuration
   - Set `SECRET_KEY`, `DEBUG`, and `ALLOWED_HOSTS`
   - Configure database settings if using PostgreSQL

5. **Run migrations**
   ```bash
   python manage.py migrate
   ```

6. **Create superuser**
   ```bash
   python manage.py createsuperuser
   ```

7. **Collect static files**
   ```bash
   python manage.py collectstatic
   ```

8. **Run development server**
   ```bash
   python manage.py runserver
   ```

## üîß Configuration

### Telegram Setup

1. Create Telegram bots via [@BotFather](https://t.me/botfather)
2. Add bots in the admin panel (`/admin/telegram_app/telegrambot/`)
3. Configure channels and add them to the system
4. Set default message settings per bot if needed

### Template Configuration

1. Upload background images via admin panel
2. Configure logos and watermarks
3. Create category-specific or special price templates
4. Use the visual template editor for custom layouts

### User Roles

- **Management**: Full access to all features
- **Employee**: Standard operational access
- **Developer**: Technical access with additional privileges

## üìñ Usage

### Price Management Workflow

1. **Create Categories**: Organize your price types into categories
2. **Define Price Types**: Create price types with currency pairs and trade directions
3. **Update Prices**: Update prices individually or in bulk
4. **Review**: Check pending prices in the finalization dashboard
5. **Finalize**: Select prices, choose channel, add notes, and finalize
6. **Publish**: System automatically renders image and publishes to Telegram

### Special Prices

- Create special price types independently
- Update special prices separately from regular prices
- Finalize and publish special prices individually

### Analytics

- Access the analytics dashboard to view:
  - Price trends over time
  - Category summaries
  - Top movers
  - Finalization statistics
  - System-wide metrics

### Template Editing

- Use the visual template editor to:
  - Position text and image elements
  - Adjust fonts, colors, and sizes
  - Preview templates before saving

## üîí Security

- All views require authentication (enforced by middleware)
- Role-based access control
- CSRF protection enabled
- Secure session management
- Input validation and sanitization

## üìä Database Models

### Core Models

- `CustomUser`: Extended user model with roles
- `Currency`: Currency definitions
- `Category`: Price categories
- `PriceType`: Price type definitions
- `PriceHistory`: Price change history
- `SpecialPriceType`: Special price types
- `SpecialPriceHistory`: Special price history
- `Finalization`: Finalization records
- `PriceTemplate`: Template configurations
- `TelegramBot`: Telegram bot configurations
- `TelegramChannel`: Telegram channel configurations
- `Log`: Application logging

## üõ†Ô∏è Development

### Running Tests

```bash
python manage.py test
```

### Code Style

Follow PEP 8 guidelines and Django best practices.

### Adding New Features

1. Create migrations for model changes: `python manage.py makemigrations`
2. Apply migrations: `python manage.py migrate`
3. Update admin configurations if needed
4. Add URL patterns and views
5. Create templates and static files

## üìù API Endpoints

### Pricing Data API

The Pricing Data API exposes a **read-only JSON view of all pricing data**, suitable for dashboards, bots, and external systems.

- **Base URL (including project routing)**: `GET /analysis/api/pricing/`
- **Authentication**: Disabled by default for this endpoint (can be enabled via DRF settings).
- **Methods**: `GET` only (fully read-only).

#### Response Structure

The endpoint returns a single JSON object:

```json
{
  "generated_at": "2025-01-01T12:00:00Z",
  "categories": [
    {
      "id": 1,
      "name": "Cash",
      "slug": "cash",
      "description": "Cash exchange prices",
      "items": [
        {
          "id": 10,
          "name": "USD / IRR Buy",
          "pair": "USD/IRR",
          "trade_type": "Buy",
          "latest_price": "123456.78",
          "latest_price_timestamp": "2025-01-01T11:55:00Z"
        }
      ]
    },
    {
      "id": null,
      "name": "Special Prices",
      "slug": "special-prices",
      "description": "Special price types with updates in the last 6 hours.",
      "items": [
        {
          "id": 5,
          "name": "Special Pound",
          "pair": "GBP/IRR",
          "trade_type": "Sell",
          "latest_special_price": "550000.00",
          "latest_special_price_timestamp": "2025-01-01T11:40:00Z"
        }
      ]
    }
  ]
}
```

#### Semantics

- **`generated_at`**  
  ISO8601 timestamp when the payload was generated (server time, UTC).

- **`categories`**  
  List of **category objects** with the following structure:

  - **`id`**  
    Database ID of the `Category`.  
    - For the synthetic *Special Prices* category, this value is **`null`**.

  - **`name`**  
    Human-readable category name (for example: `"Cash"`).

  - **`slug`**  
    URL-friendly slug string (for example: `"cash"`).  
    May be reused in other parts of the system for routing or labels.

  - **`description`** *(optional, nullable)*  
    Free-text category description.  
    - May be **`null`** if no description is provided.

  - **`items`**  
    List of pricing item objects for that category.  
    - May be an empty list (`[]`) if the category has no current items.

For **regular categories**, each item has:

- **id**: ID of the `PriceType`.
- **name**: Name of the `PriceType`.
- **pair**: String representing the currency pair, e.g. `"USD/IRR"`.
- **trade_type**: Human-readable trade direction, e.g. `"Buy"` or `"Sell"`.
- **latest_price**: Latest numeric price for this type (stringified decimal).
- **latest_price_timestamp**: Timestamp of the latest recorded price (`PriceHistory.created_at`).

For the **synthetic "Special Prices" category**, items come from `SpecialPriceType` and `SpecialPriceHistory`:

- **id**: ID of the `SpecialPriceType`.
- **name**: Name of the special price type.
- **pair**: Currency pair for the special price.
- **trade_type**: Human-readable trade direction.
- **latest_special_price**: Latest special price value (stringified decimal).
- **latest_special_price_timestamp**: Timestamp of the latest *special price* (`SpecialPriceHistory.created_at`).

#### Business Rules

- **All categories are always included**:
  - Every `Category` record is returned, even if it currently has no price items.
  - In that case, `items` is an empty array (`[]`).
- **Regular price items**:
  - Each category‚Äôs `items` list is built from `PriceType` **with at least one `PriceHistory` entry**.
  - Only the **latest** price per type is exposed.
- **Special prices**:
  - The *Special Prices* category aggregates `SpecialPriceType` entries.
  - **Only items with a `SpecialPriceHistory` in the last 6 hours are included**.
  - If no special prices have been updated in the last 6 hours, the *Special Prices* category is still present, but `items` is empty.

#### DRF & Security Notes

- Implemented using **Django REST Framework** (`analysis.views.PricingDataAPIView`).  
- The view is **GET-only** and does not support POST/PUT/PATCH/DELETE.
- `authentication_classes` and `permission_classes` are **empty by default** but can be configured:
  - Example: `SessionAuthentication`, `TokenAuthentication`, `IsAuthenticated`, etc.
- Throttling support can be enabled via DRF‚Äôs `AnonRateThrottle` / `UserRateThrottle` and `DEFAULT_THROTTLE_RATES`.
- **CORS** is handled globally (e.g. via `django-cors-headers`); the view itself is CORS-agnostic.

#### Typical Use Cases

- Powering a **public JSON endpoint** for currency prices.
- Feeding **frontend dashboards** or **mobile apps** that need current prices and special offers.
- Providing a **machine-readable feed** for other services (e.g. partner sites, bots, or monitoring tools).

### Template Editor API

- `GET /api/templates/`: List all templates
- `POST /api/templates/`: Create new template
- `GET /api/templates/{id}/`: Get template details
- `PUT /api/templates/{id}/`: Update template
- `DELETE /api/templates/{id}/`: Delete template

## üêõ Troubleshooting

### Common Issues

1. **Telegram publishing fails**
   - Verify bot token is correct
   - Ensure bot has permission to send messages to channel
   - Check channel chat_id is correct

2. **Image rendering errors**
   - Verify template assets (backgrounds, fonts) exist
   - Check file permissions
   - Ensure Pillow is properly installed

3. **Database errors**
   - Run migrations: `python manage.py migrate`
   - Check database connection settings

## üìÑ License

[Specify your license here]

## üë• Contributors

[Add contributors here]

## üîó Links

- Production: https://panel.sarafipardis.co.uk
- Admin: https://admin.sarafipardis.co.uk

## üìß Support

For support and questions, please contact the development team.

---

**Built with ‚ù§Ô∏è for efficient currency exchange price management**
