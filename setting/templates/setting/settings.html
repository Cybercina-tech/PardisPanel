{% extends "base.html" %}
{% load telegram_tags %}

{% block title %}Settings - Sarafi Pardis Panel{% endblock %}

{% block content %}
  <script>
      document.addEventListener('DOMContentLoaded', function() {
          // Get current theme
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
          
          // Update button states
          const darkBtn = document.getElementById('themeDarkBtn');
          const lightBtn = document.getElementById('themeLightBtn');
          
          if (currentTheme === 'dark') {
              darkBtn.classList.add('active');
              lightBtn.classList.remove('active');
          } else {
              lightBtn.classList.add('active');
              darkBtn.classList.remove('active');
          }
          
          // Theme switch handlers
          darkBtn.addEventListener('click', function() {
              switchTheme('dark');
          });
          
          lightBtn.addEventListener('click', function() {
              switchTheme('light');
          });
          
          function switchTheme(theme) {
              document.documentElement.setAttribute('data-theme', theme);
              localStorage.setItem('theme', theme);
              
              // Update buttons
              if (theme === 'dark') {
                  darkBtn.classList.add('active');
                  lightBtn.classList.remove('active');
              } else {
                  lightBtn.classList.add('active');
                  darkBtn.classList.remove('active');
              }
              
              // Update floating theme switcher icon if it exists
              const themeIcon = document.getElementById('themeIcon');
              if (themeIcon) {
                  if (theme === 'light') {
                      themeIcon.className = 'fas fa-sun';
                  } else {
                      themeIcon.className = 'fas fa-moon';
                  }
              }
          }
      });
  </script>

<div class="py-4">
          <!-- Page Header -->
      <div class="mb-4">
          <h1 class="text-gold fw-bold mb-2">
              <i class="fas fa-cog section-icon"></i>
              Settings
          </h1>
          <p class="text-white-50 mb-0">Manage your application settings and configurations</p>
      </div>

      <!-- Template Dashboard Shortcut -->
      <div class="settings-section">
          <div class="card shadow-lg border-0 rounded-4 theme-card-bg">
              <div class="card-header py-4 theme-header-bg border-0 rounded-top-4 d-flex justify-content-between align-items-center">
                  <div>
                      <h3 class="mb-0 text-gold fw-bold">
                          <i class="fas fa-images me-2"></i>
                          Template Dashboard
                      </h3>
                      <p class="text-white-50 mb-0 mt-2 small">Manage the images and layouts used for Telegram price posts.</p>
                  </div>
                  <a href="{% url 'price_publisher:template_dashboard' %}" class="btn btn-gold">
                      <i class="fas fa-external-link-alt me-2"></i>Open dashboard
                  </a>
              </div>
              <div class="card-body p-4">
                  <p class="text-white-50 mb-0">
                      Upload background, logo, and watermark images. Assign different templates to each category or special price type for fully customised price posts.
                  </p>
              </div>
          </div>
      </div>

      <!-- Theme Settings Section -->
      <div class="settings-section">
          <div class="card shadow-lg border-0 rounded-4 theme-card-bg">
              <div class="card-header py-4 theme-header-bg border-0 rounded-top-4">
                  <h3 class="mb-0 text-gold fw-bold">
                      <i class="fas fa-palette me-2"></i>
                      Appearance Settings
                  </h3>
                  <p class="text-white-50 mb-0 mt-2 small">Customize the look and feel of your dashboard</p>
              </div>
              <div class="card-body p-4">
                  <div class="row align-items-center">
                      <div class="col-md-8">
                          <h5 class="text-gold mb-2">Theme Selection</h5>
                          <p class="text-white-50 mb-0">Switch between dark (gold) and light (blue) themes. Your preference will be saved automatically.</p>
                      </div>
                      <div class="col-md-4 text-end">
                          <div class="theme-switch-container">
                              <label class="form-label text-gold mb-2 d-block">Current Theme:</label>
                              <div class="btn-group" role="group" id="themeSwitchGroup">
                                  <button type="button" class="btn btn-outline-gold" data-theme="dark" id="themeDarkBtn">
                                      <i class="fas fa-moon me-2"></i>Dark
                                  </button>
                                  <button type="button" class="btn btn-outline-gold" data-theme="light" id="themeLightBtn">
                                      <i class="fas fa-sun me-2"></i>Light
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- Telegram Bots Management Section -->
    <div class="settings-section">
        <div class="card shadow-lg border-0 rounded-4 theme-card-bg">
            <div class="card-header py-4 theme-header-bg border-0 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0 text-gold fw-bold">
                            <i class="fas fa-robot me-2"></i>
                            Telegram Bots
                        </h3>
                        <p class="text-white-50 mb-0 mt-2 small">Manage your Telegram bots</p>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Add Bot Form -->
                <div class="mb-4">
                    <h5 class="text-gold mb-3">Add New Bot</h5>
                    <form method="POST" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="add_bot">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ bot_form.name.id_for_label }}" class="form-label fw-semibold text-gold">
                                    {{ bot_form.name.label }}
                                </label>
                                {{ bot_form.name }}
                                {% if bot_form.name.errors %}
                                    <div class="invalid-feedback d-block text-danger">
                                        {{ bot_form.name.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ bot_form.token.id_for_label }}" class="form-label fw-semibold text-gold">
                                    {{ bot_form.token.label }}
                                </label>
                                {{ bot_form.token }}
                                {% if bot_form.token.errors %}
                                    <div class="invalid-feedback d-block text-danger">
                                        {{ bot_form.token.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ bot_form.is_active.id_for_label }}" class="form-label fw-semibold text-gold d-block">
                                    {{ bot_form.is_active.label }}
                                </label>
                                <div class="form-check form-switch">
                                    {{ bot_form.is_active }}
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-gold">
                            <i class="fas fa-plus me-2"></i>Add Bot
                        </button>
                    </form>
                </div>

                <hr class="section-divider">

                <!-- Bots List -->
                <div>
                    <h5 class="text-gold mb-3">Existing Bots</h5>
                    {% if bots %}
                        <div class="table-responsive rounded-4 overflow-hidden shadow-sm">
                            <table class="table table-dark-custom table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Token (masked)</th>
                                        <th>Status</th>
                                        <th>Channels</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bot in bots %}
                                    <tr>
                                        <td class="text-white">{{ bot.name }}</td>
                                        <td class="text-white-50">
                                            {% if bot.token|length > 20 %}
                                                {{ bot.token|slice:":10" }}...{{ bot.token|slice:"-5:" }}
                                            {% else %}
                                                ****
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if bot.is_active %}
                                                <span class="badge badge-active">Active</span>
                                            {% else %}
                                                <span class="badge badge-inactive">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-white-50">{{ bot.channels.count }}</td>
                                        <td class="text-white-50">{{ bot.created_at|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            <a href="{% url 'setting:edit_bot' bot.id %}" class="btn btn-sm btn-outline-gold me-2">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <form method="POST" action="{% url 'setting:delete_bot' bot.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this bot? This will also delete all associated channels.');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger-outline">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-white-50">No bots configured yet. Add your first bot above.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Channels Management Section -->
    <div class="settings-section">
        <div class="card shadow-lg border-0 rounded-4 theme-card-bg">
            <div class="card-header py-4 theme-header-bg border-0 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0 text-gold fw-bold">
                            <i class="fas fa-broadcast-tower me-2"></i>
                            Telegram Channels
                        </h3>
                        <p class="text-white-50 mb-0 mt-2 small">Manage your Telegram channels</p>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Add Channel Form -->
                <div class="mb-4">
                    <h5 class="text-gold mb-3">Add New Channel</h5>
                    <form method="POST" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="add_channel">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="{{ channel_form.bot.id_for_label }}" class="form-label fw-semibold text-gold">
                                    {{ channel_form.bot.label }}
                                </label>
                                {{ channel_form.bot }}
                                {% if channel_form.bot.errors %}
                                    <div class="invalid-feedback d-block text-danger">
                                        {{ channel_form.bot.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ channel_form.name.id_for_label }}" class="form-label fw-semibold text-gold">
                                    {{ channel_form.name.label }}
                                </label>
                                {{ channel_form.name }}
                                {% if channel_form.name.errors %}
                                    <div class="invalid-feedback d-block text-danger">
                                        {{ channel_form.name.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ channel_form.chat_id.id_for_label }}" class="form-label fw-semibold text-gold">
                                    {{ channel_form.chat_id.label }}
                                </label>
                                {{ channel_form.chat_id }}
                                {% if channel_form.chat_id.errors %}
                                    <div class="invalid-feedback d-block text-danger">
                                        {{ channel_form.chat_id.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ channel_form.is_active.id_for_label }}" class="form-label fw-semibold text-gold d-block">
                                    {{ channel_form.is_active.label }}
                                </label>
                                <div class="form-check form-switch">
                                    {{ channel_form.is_active }}
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-gold">
                            <i class="fas fa-plus me-2"></i>Add Channel
                        </button>
                    </form>
                </div>

                <hr class="section-divider">

                <!-- Channels List -->
                <div>
                    <h5 class="text-gold mb-3">Existing Channels</h5>
                    {% if channels %}
                        <div class="table-responsive rounded-4 overflow-hidden shadow-sm">
                            <table class="table table-dark-custom table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Bot</th>
                                        <th>Chat ID</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for channel in channels %}
                                    <tr>
                                        <td class="text-white">{{ channel.name }}</td>
                                        <td class="text-white-50">{{ channel.bot.name }}</td>
                                        <td class="text-white-50">{{ channel.chat_id }}</td>
                                        <td>
                                            {% if channel.is_active %}
                                                <span class="badge badge-active">Active</span>
                                            {% else %}
                                                <span class="badge badge-inactive">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-white-50">{{ channel.created_at|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            <a href="{% url 'setting:edit_channel' channel.id %}" class="btn btn-sm btn-outline-gold me-2">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <form method="POST" action="{% url 'setting:delete_channel' channel.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this channel?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-sm btn-danger-outline">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-white-50">No channels configured yet. Add your first channel above.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Message Sending Section -->
    <div class="settings-section">
        <div class="card shadow-lg border-0 rounded-4 theme-card-bg">
            <div class="card-header py-4 theme-header-bg border-0 rounded-top-4">
                <h3 class="mb-0 text-gold fw-bold">
                    <i class="fab fa-telegram-plane me-2"></i>
                    Send Telegram Message
                </h3>
                <p class="text-white-50 mb-0 mt-2 small">Send messages to your Telegram channels</p>
            </div>
            <div class="card-body p-4">
                <form method="POST" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="send_message">
                    <div class="mb-3">
                        <label for="{{ telegram_form.bot.id_for_label }}" class="form-label fw-semibold text-gold">
                            {{ telegram_form.bot.label }}
                        </label>
                        {{ telegram_form.bot }}
                        {% if telegram_form.bot.help_text %}
                            <small class="form-text text-muted">{{ telegram_form.bot.help_text }}</small>
                        {% endif %}
                        {% if telegram_form.bot.errors %}
                            <div class="invalid-feedback d-block text-danger">
                                {{ telegram_form.bot.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ telegram_form.channel.id_for_label }}" class="form-label fw-semibold text-gold">
                            {{ telegram_form.channel.label }}
                        </label>
                        {{ telegram_form.channel }}
                        {% if telegram_form.channel.help_text %}
                            <small class="form-text text-muted">{{ telegram_form.channel.help_text }}</small>
                        {% endif %}
                        {% if telegram_form.channel.errors %}
                            <div class="invalid-feedback d-block text-danger">
                                {{ telegram_form.channel.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ telegram_form.message.id_for_label }}" class="form-label fw-semibold text-gold">
                            {{ telegram_form.message.label }}
                        </label>
                        {{ telegram_form.message }}
                        {% if telegram_form.message.help_text %}
                            <small class="form-text text-muted">{{ telegram_form.message.help_text }}</small>
                        {% endif %}
                        {% if telegram_form.message.errors %}
                            <div class="invalid-feedback d-block text-danger">
                                {{ telegram_form.message.errors|striptags }}
                            </div>
                        {% endif %}
                    </div>
                    {% if telegram_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ telegram_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <div class="d-grid">
                        <button type="submit" class="btn btn-gold btn-lg fw-bold shadow-sm">
                            <i class="fas fa-paper-plane me-2"></i> Send Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
